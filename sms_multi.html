<!DOCTYPE html>
<html>
<head>
<title>Multi Ajax</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="-1">
<script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
<style type="text/css">
body {
  font-family: sans-serif;
  font-size: 10pt;
}

#SenderTemplate {
  display: none;
}

#SendersContainer {
  display: block;
  *border: 1px dotted red;
}

.Sender {
  display: inline-block;
  border: 2px solid darkblue;
  background-color: rgb(248, 248, 248);
  border-radius: 15px;
  padding: 3px;
  width: 250px;
  margin: 2px;
}

.Sender label {
  font-weight: bold;
  margin-right: 2px;
}

.Sender p {
  *border: 1px dotted red;
  margin: 0px 2px;
}

.Sender span {
  *border: 1px dotted green;
  margin-right: 2px;
}

.Sender .rm {
  float: right;
}

.Sender .ms {
  display: block;
  box-sizing: content-box;
  height: 7em;
  border-radius: 5px;
  border: 1px solid #CCC;
  background-color: #FFF;
  font-family: Consolas, 'Courier New', monospace;
  padding: 3px 5px;
}

#UltMsgs {
  font-family: Consolas, 'Courier New', monospace;
}

#UltMsgs .sending {
  background-color: rgb(255, 243, 136);
}

#UltMsgs .sent {
  background-color: rgb(208, 253, 186);
}

</style>

<script>
  var aCtr = {};
  var qtdErro  = new Number(0);

  $(document).ready(function () {
    $('body').on('click', '#SendersContainer .rm', function() {
      var id = this.parentNode.parentNode.getAttribute('id');
      clearInterval(aCtr[id].loopCtr);
      aCtr[id].el.remove();
      delete aCtr[id];

      $('#SendersQt').html(Object.keys(aCtr).length);
    });

    $('#Add').click(function() {
      var id = 'Sndr' + Math.floor(Math.random() * 10000000000);
      var el = document.querySelector('#SenderTemplate div.Sender').cloneNode(true);
      el.setAttribute('id', id);

      $('#SendersContainer').append(el);

      var loopCtr = setInterval(updateSender, 1000, id);

      aCtr[id] = {
        'loopCtr': loopCtr,
        'el': el,
        'running': false,
      };

      updateSender(id);

      $('#SendersQt').html(Object.keys(aCtr).length);
    });

    setTimeout(saveMessages, 1000);
  });

  var updateSender = (function (id) {
    if (aCtr[id].running) return true;

    getMessage (id);
    // console.log(id);
  });

  function getMessage (id) {
    $.ajax ({
      url: 'mock.php',
      data: {
        TipoMsg: "SMSMSG_V03",
        Msg: "1|SMSMSG_V03|" + formatDate()
      },
      type: 'GET',
      dataType: 'text',
      timeout: 60000,
      beforeSend: function() {
        aCtr[id].running = true;
        $('#' + id + '.Sender .st').html('Ajax');
      },
      error: function (XMLHttpRequest, textStatus, errorThrown) {
        console.log('error');
        // emErro = true;
        // qtdErro++;

        lastMsg = 'Ocorreu um erro ao executar ajax: [' + textStatus + '], [' + errorThrown + '], [' + XMLHttpRequest.responseText + ']';
      },
      success: function (data, textStatus) {
        // console.log('OK');
        // console.log(data);
        if (data.substr(0, 3) != 'OK ') {
          emErro = true;
          qtdErro++;

          lastMsg = 'Resposta do ajax inválida: [' + data.msg_ret + ']';
          $('#' + id + '.Sender .ms').html(lastMsg);
        } else {

          data = data.substr(3);
          lastMsg = data;

          var cpos = data.split('|');

          $('#UltMsgs').prepend('<p>' + data + '</p>');

          $('#' + id + '.Sender .rp').html(cpos[1]);
          $('#' + id + '.Sender .gr').html(cpos[2]);
          $('#' + id + '.Sender .fn').html('(' + cpos[3] + ') ' + cpos[4].substr(0, 5) + '-' + cpos[4].substr(5));
          $('#' + id + '.Sender .ms').html(cpos[5]);

          // console.log(cpos);

          // var dv = $('<div>');
          // for (var i = 0; i < data.dadosRamal.length; i++) {
          //   var $sp = $('<span class="oculto">' + data.dadosRamal[i].grupo + '(' + data.dadosRamal[i].RLogQ + ')</span>');
          //   $(dv).append($sp);
          // }


          // $('#dvOcultos').html(dv);
        }
      },
      complete: function() {
      //   var dt = new DateTime();
      //   var DtHr = dt.formats.compound.mySQL;

      //   $('#spMsg').html('[' + DtHr + ']:' + lastMsg);

      //   if (emErro) {
      //     $('#spMsg').addClass('dvErro');
      //     $('#imIcoStatus').attr('src', '/callcenter/imagens/erro_18px.gif');
      //   } else {
      //     $('#dvMsgStatus').html('Ok');
      //     if (qtdErro > 0) {
      //       $('#imIcoStatus').attr('src', '/callcenter/imagens/alerta_18px.gif');
      //     } else {
      //       $('#imIcoStatus').attr('src', '/callcenter/imagens/check_18px.gif');
      //     }
      //   }
        $('#' + id + '.Sender .st').html('Waiting');
        aCtr[id].running = false;
      }
    });
  }

  function saveMessages() {

    var dataToSend = [];
    $('#UltMsgs p').not('.sent').each(function (index, value){
      // console.log($(this).html());

      dataToSend.push({
        m: $(this).html()
      });

      $(this).addClass('sending');
    });

    if (dataToSend.length == 0) {
      setTimeout(saveMessages, 1000);
      return true;
    }

    // console.log(dataToSend);



    $.ajax ({
      url: 'mock2.php',
      data: {
        messages: dataToSend
      },
      type: 'POST',
      dataType: 'json',
      timeout: 60000,
      beforeSend: function() {
      },
      error: function (XMLHttpRequest, textStatus, errorThrown) {
        // console.log('error Sending Messages to Log');
        // emErro = true;
        // qtdErro++;

        console.log('Error Sending Messages to Log: [' + textStatus + '], [' + errorThrown + '], [' + XMLHttpRequest.responseText + ']');
      },
      success: function (data, textStatus) {
        // console.log(data);

        $('#UltMsgs p.sending').addClass('sent').removeClass('sending');

        // console.log('OK');
        // console.log(data);
        // if (data.substr(0, 3) != 'OK ') {
        //   emErro = true;
        //   qtdErro++;

        //   lastMsg = 'Resposta do ajax inválida: [' + data.msg_ret + ']';
        //   $('#' + id + '.Sender .ms').html(lastMsg);
        // } else {

        //   data = data.substr(3);
        //   lastMsg = data;

        //   var cpos = data.split('|');

        //   $('#UltMsgs').prepend('<p>' + data + '</p>');

        //   $('#' + id + '.Sender .rp').html(cpos[1]);
        //   $('#' + id + '.Sender .gr').html(cpos[2]);
        //   $('#' + id + '.Sender .fn').html('(' + cpos[3] + ') ' + cpos[4].substr(0, 5) + '-' + cpos[4].substr(5));
        //   $('#' + id + '.Sender .ms').html(cpos[5]);

        //   // console.log(cpos);

        //   // var dv = $('<div>');
        //   // for (var i = 0; i < data.dadosRamal.length; i++) {
        //   //   var $sp = $('<span class="oculto">' + data.dadosRamal[i].grupo + '(' + data.dadosRamal[i].RLogQ + ')</span>');
        //   //   $(dv).append($sp);
        //   // }


        //   // $('#dvOcultos').html(dv);
        // }
      },
      complete: function() {
        setTimeout(saveMessages, 1000);
      }
    });

  }

  function formatDate() {
    var d = new Date(),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear(),
        hour = d.getHours(),
        min = d.getMinutes(),
        secs = d.getSeconds();

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;

    if (hour.length < 2) hour = '0' + hour;
    if (min.length < 2) min = '0' + min;
    if (secs.length < 2) secs = '0' + secs;

    return [year, month, day].join('-') + ' ' + [hour, min, secs].join(':');
}

</script>
</head>
<body>

<button id="Add"> + </button><span id="SendersQt">0</span>
<div id="SendersContainer"></div>
<div id="UltMsgs"></div>

<div id="SenderTemplate">
<div class="Sender">
  <p><label>St:</label><span class="st">Init</span><button class="rm"> - </button></p>
  <p><label>Repre:</label><span class="rp">...</span></p>
  <p><label>Grupo:</label><span class="gr">...</span><label>Fone:</label><span class="fn">...</span></p>
  <p><span class="ms">...</span></p>
</div>
</div>
</body>
</html>